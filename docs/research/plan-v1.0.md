# meo-gpt-connector — High-Level Architecture Plan v1.0

Date: 2026-02-22
Status: Draft for design phase

---

## 1) Purpose and Scope

This plan defines the **high-level architecture** for `meo-gpt-connector`, a standalone service that connects a ChatGPT Custom GPT (Actions) to the Meo Mai Moi main app API.

Primary objective for v1:
- deliver a secure, deterministic, chat-first MVP with minimal operational complexity.

Out of scope for v1:
- complex AI pipelines in backend,
- OCR/ML extraction jobs,
- UI embedding in main app.

---

## 2) Key Decisions (Locked for v1)

Based on recommendations review + project discussion:

1. **Connector stack**: **Python + FastAPI**
   - Rationale: OpenAPI-first, strong schema validation, rapid prototyping, clean ChatGPT Actions fit.

2. **Auth model**: **OAuth2 Authorization Code using Laravel Passport**
   - Rationale: standards-based, native fit for ChatGPT Actions, avoids fragile custom identity bridges.

3. **Boundary**: **Thin adapter**
   - Connector handles auth mediation, validation, normalization, observability, rate limiting, and error shaping.
   - Main app remains source of truth and owner of domain logic.

4. **MVP file/domain change**:
   - Replace generic “document upload” scope with **vaccination record update**.
   - Use **two-step upload pattern** to support robust retries and attach semantics.

---

## 3) Architectural Principles

1. **Deterministic backend authority**
   - LLM interprets language; backend validates/enforces business rules.
   - Computed/domain-critical values are generated by backend, not LLM.

2. **Tool-friendly contracts**
   - Explicit required fields, strong enums, stable response shapes, structured errors.

3. **Least privilege + minimal sensitive state**
   - No token leakage in logs.
   - Avoid persistent PII in connector where not required.

4. **Thin connector, no domain duplication**
   - No second system of record.

---

## 4) System Context

User
→ ChatGPT Custom GPT
→ Actions calls (OpenAPI)
→ meo-gpt-connector (FastAPI)
→ Meo Mai Moi Main App API (Laravel)
→ Main DB/Storage

### Responsibility Split

**ChatGPT GPT**
- Understands natural language.
- Asks clarifying questions when required fields are missing.
- Calls Actions and renders user-facing responses.

**Connector (this project)**
- Exposes Actions-compatible OpenAPI.
- Enforces request/response schemas.
- Mediates OAuth2 token usage.
- Applies rate limits and structured logging.
- Translates backend errors into conversational-safe machine-readable errors.

**Main App**
- Owns pets, vaccinations, and domain rules.
- Performs authoritative writes/reads and computed outputs.

---

## 5) Authentication & Authorization Design

## 5.1 ChatGPT Actions Auth

- Configure GPT Actions with OAuth2 Authorization Code flow.
- Laravel Passport acts as OAuth provider.
- ChatGPT securely stores user tokens and sends Bearer token on Actions calls.

## 5.2 Connector Auth Handling

- Validate incoming Bearer token format and required scopes.
- Forward token to main app API when calling user-bound endpoints.
- Do not persist raw user tokens beyond operational necessity.

## 5.3 Security Controls

- HTTPS only.
- Rate limit all public endpoints (global + per-token/IP policies).
- Structured audit fields: request_id, endpoint, status, latency, user_ref.
- Redact authorization headers and sensitive payload fragments in logs.

---

## 6) MVP Functional Scope (Updated)

1. Connect account (OAuth)
2. Create pet via chat
3. List/query pets
4. Basic pet corrections (e.g., birthdate fix)
5. **Vaccination record update** (replacing generic document-upload user story)

### Note on vaccination updates

MVP supports updating vaccination record data and associating supporting artifacts via a two-step pattern if needed, while keeping domain validation in main app.

---

## 7) API Surface (Connector v1 draft)

Core endpoints (high-level):
- `GET /health`
- `GET /.well-known/openapi.json` (or equivalent published OpenAPI route)
- `POST /pets`
- `GET /pets`
- `GET /pets/{id}`
- `PATCH /pets/{id}`
- `POST /vaccination-records/uploads` (step 1: initiate/receive upload)
- `POST /pets/{id}/vaccination-records` (step 2: attach/update structured vaccination data)

### Error shape (standardized)

All non-success responses should be structured and GPT-recoverable, e.g.:

```json
{
  "error": "VALIDATION_ERROR",
  "message": "birth_date must be in YYYY-MM-DD format",
  "fields": [{"name":"birth_date","reason":"invalid_format"}],
  "request_id": "..."
}
```

---

## 8) Conversational Reliability Rules

1. Missing required fields → return precise validation metadata.
2. Ambiguous intent (e.g., pet not uniquely identified) → return disambiguation options.
3. Writes should support idempotency where feasible (idempotency key for create/update-sensitive operations).
4. Keep success payloads concise and machine-friendly.

---

## 9) Data & Integration Constraints

1. Main app is only source of truth.
2. Connector should avoid long-term business state.
3. File/vaccination artifact flow uses two-step design to reduce partial-failure risk.
4. Responses should include canonical identifiers required for follow-up actions.

---

## 10) Deployment & Ops (v1)

- Single container deployment for connector.
- Env-based config:
  - main app API base URL,
  - OAuth issuer/audience metadata,
  - rate-limit settings,
  - log level.
- Basic readiness/liveness checks.
- Alerting baseline: high 5xx rate, auth failures spike, latency degradation.

---

## 11) Phase Plan After v1.0

### Phase 1 (Build MVP)
- Implement auth wiring, pet create/list/update, vaccination update flows.
- Publish stable OpenAPI for Actions.

### Phase 2 (Hardening)
- Expand observability, idempotency coverage, replay-safe write behavior.
- Improve disambiguation/error taxonomy.

### Phase 3 (Enhancements)
- Add helper read models and summary endpoints for richer Q&A.
- Consider optional background extraction/verification flows.

---

## 12) Open Questions for Next Design Pass

1. Final OAuth token lifetime + refresh policy for GPT use.
2. Exact scope model (read/write granular scopes by resource).
3. Canonical vaccination schema fields required in v1.
4. Whether upload step stores binaries directly in main app or via pre-signed URL gateway.

---

## 13) Acceptance Criteria for this Plan

This `plan-v1.0` is accepted when team agrees that:
- stack/auth/boundary decisions are stable for MVP,
- v1 endpoint surface is sufficient for defined user stories,
- security and observability baseline is adequate to start implementation design.
